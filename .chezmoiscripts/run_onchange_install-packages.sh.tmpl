#!/bin/bash

# packages.yaml hash: {{ .packages | toString | sha256sum }}
# wgets hash: {{ .packages | toString | sha256sum }}
# brewfile - https://docs.brew.sh/Brew-Bundle-and-Brewfile

echo "#############################################"
echo ""
echo "Installing core packages with brew"
echo ""

brew bundle --file=/dev/stdin <<EOF
{{ range .packages.core.brews -}}
brew {{ . | quote }}
{{ end -}}
EOF

echo "#############################################"
echo ""
echo "Installing core packages with asdf"
echo ""

{{ range .packages.core.asdf -}}
  echo "Adding asdf plugin {{ .name }} {{ .plugin }}"
  asdf plugin add {{ .name }} {{ .plugin }}

  echo ""
  echo "Installing latest version of {{ .name }} with asdf"
  asdf install {{ .name }} latest

  echo ""
  echo "Setting global version for {{.name }} to latest"
  asdf set -u {{ .name }} latest

{{ end -}} {{/* range .packages.core.asdf */}}


echo "#############################################"
echo ""
echo "Installing shared packages using brew"
echo ""
brew bundle --file=/dev/stdin <<EOF
{{ range .packages.shared.brews.taps -}}
tap {{ . | quote}}
{{ end -}}
{{ range .packages.shared.brews.formulae -}}
brew {{ . | quote }}
{{ end -}}
{{ range .packages.shared.brews.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF

echo "#############################################"
echo ""
echo "Installing shared packages using wget"
echo ""

{{ range .packages.shared.wgets -}}
TEMP_DIR=$(mktemp -d)
echo "Fetching {{ .name }}"
  {{ if  .tar -}}
    wget {{ .url }} -O - | tar -xz -C "$TEMP_DIR"
  {{ else -}}
    wget {{ .url }} -O $TEMP_DIR/{{ .name }}
    ls "$TEMP_DIR"/{{ .name }}
  {{ end -}}
  mv "$TEMP_DIR"/{{ .name }} "$HOME/bin/"
  chmod +x "$HOME/bin/{{ .name }}"
{{ end -}} {{/* rrange .packages.shared.wgets */}}

echo "#############################################"
echo ""
echo "Installing shared packages using asdf"
echo ""

{{ range .packages.shared.asdf -}}
  echo "Adding asdf plugin"
  asdf plugin add {{ .name }} {{ .plugin }}

  echo ""
  echo "Installing latest version of {{ .name }} with asdf"
  asdf install {{ .name }} latest

  echo ""
  echo "Setting global version for {{.name }} to latest"
  asdf set -u {{ .name }} latest

{{ end -}} {{/* range .packages.shared.asdf */}}


echo "#############################################"
echo ""
echo "Installing profile-specific ({{ .profile }}) packages using brew"
echo ""

{{ range .packages.shared.npm -}}
  if ! npm list -g {{ . }} &> /dev/null; then
    echo "Installing {{ . }}"
    npm install -g {{ . }}
  else
    echo "{{ . }} already installed"
  fi
{{ end -}}


{{ if .packages.profiles -}}
{{ $profile := .profile -}}


echo "#############################################"
echo ""
echo "Installing ({{ .profile }}) profile specific packages using brew"
echo ""

brew bundle --file=/dev/stdin <<EOF
{{ range (index .packages.profiles $profile).brews.taps -}}
tap {{ . | quote }}
{{ end -}}
{{ range (index .packages.profiles $profile).brews.formulae -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index .packages.profiles $profile).brews.casks -}}
cask {{ . | quote }}
{{ end -}}
EOF

echo "#############################################"
echo ""
echo "Installing ({{ .profile }}) profile specific packages using npm"
echo ""
{{ range (index .packages.profiles $profile).npm -}}
  if ! npm list -g {{ . }} &> /dev/null; then
    echo "Installing {{ . }} for {{ $profile }} profile"
    npm install -g {{ . }}
  else
    echo "{{ . }} already installed"
  fi
{{ end -}}{{/* range (index .packages.profiles $profile).npm */}}

echo "#############################################"
echo ""
echo "Installing ({{ .profile }}) profile specific packages using wget"
echo ""

{{ range (index .packages.profiles $profile).wgets -}}
TEMP_DIR=$(mktemp -d)
echo "Fetching {{ .name }}"
  {{ if  .tar -}}
    wget {{ .url }} -O - | tar -xz -C "$TEMP_DIR"
  {{ else -}}
    wget {{ .url }} -O $TEMP_DIR/{{ .name }}
    ls "$TEMP_DIR"/{{ .name }}
  {{ end -}}
  mv "$TEMP_DIR"/{{ .name }} "$HOME/bin/"
  chmod +x "$HOME/bin/{{ .name }}"
{{ end -}} {{/* range (index .packages.profiles $profile).wgets */}}

echo "#############################################"
echo ""
echo "Installing ({{ .profile }}) profile specific packages using asdf"
echo ""
{{ range (index .packages.profiles $profile).asdf -}}
  echo "Adding asdf plugin"
  asdf plugin add {{ .name }} {{ .plugin }}
  echo "Installing latest version of {{ .name }} with asdf"
  asdf install {{ .name }} latest
  echo "Setting global version for {{.name }} to latest"
  asdf set -u {{ .name }} latest
{{ end -}} {{/* range (index .packages.profiles $profile).asdf */}}
{{ end -}}{{/* if .packages.profiles */}}
